# SPDX-License-Identifier: MIT
# Copyright (c) 2026 Tom F. (https://github.com/tomtom215/duckdb-behavioral)

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

# Cancel redundant runs on the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: -Dwarnings
  RUST_BACKTRACE: 1

jobs:
  # ── Fast lint checks (run first, fail fast) ───────────────────────────
  fmt:
    name: Format
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt
      - name: Check formatting
        id: fmt-check
        run: cargo fmt --all -- --check
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.fmt-check.outcome }}" = "success" ]; then
            echo "### ✅ Format Check Passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### ❌ Format Check Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "Run \`cargo fmt --all\` to fix formatting issues." >> "$GITHUB_STEP_SUMMARY"
          fi

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Run clippy
        run: cargo clippy --all-targets --message-format=json -- -D warnings 2>&1 | tee clippy-output.json
      - name: Summary
        if: always()
        run: |
          WARNINGS=$(grep -c '"level":"warning"' clippy-output.json 2>/dev/null || echo "0")
          ERRORS=$(grep -c '"level":"error"' clippy-output.json 2>/dev/null || echo "0")
          {
            echo "### Clippy Results"
            echo ""
            echo "| Metric | Count |"
            echo "|--------|-------|"
            echo "| Errors | ${ERRORS} |"
            echo "| Warnings | ${WARNINGS} |"
            echo ""
            if [ "$ERRORS" = "0" ] && [ "$WARNINGS" = "0" ]; then
              echo "✅ Zero warnings, zero errors."
            else
              echo "❌ Issues detected. Review the log output above."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ── Compilation checks ────────────────────────────────────────────────
  check:
    name: Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Compile check (all targets)
        id: cargo-check
        run: cargo check --all-targets
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.cargo-check.outcome }}" = "success" ]; then
            echo "### ✅ Compilation check passed" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### ❌ Compilation check failed" >> "$GITHUB_STEP_SUMMARY"
          fi

  doc:
    name: Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      RUSTDOCFLAGS: -Dwarnings
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Build documentation
        id: cargo-doc
        run: cargo doc --no-deps --document-private-items
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.cargo-doc.outcome }}" = "success" ]; then
            echo "### ✅ Documentation builds without warnings" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### ❌ Documentation build failed" >> "$GITHUB_STEP_SUMMARY"
          fi

  # ── Test suite (structured output via cargo-nextest) ──────────────────
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Install cargo-nextest
        uses: taiki-e/install-action@cfdb446e391c69574ebc316dfb7d7849ec12b940 # v2
        with:
          tool: cargo-nextest

      - name: Run unit tests
        run: cargo nextest run --all-targets --profile ci 2>&1 | tee test-output.txt

      - name: Run doc tests
        run: cargo test --doc 2>&1 | tee -a test-output.txt

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results-linux
          path: target/nextest/ci/junit.xml
          retention-days: 30
          if-no-files-found: warn

      - name: Summary
        if: always()
        run: |
          {
            echo "### Test Results"
            echo ""
            if [ -f target/nextest/ci/junit.xml ]; then
              TOTAL=$(grep -oP 'tests="\K[0-9]+' target/nextest/ci/junit.xml | head -1)
              FAILURES=$(grep -oP 'failures="\K[0-9]+' target/nextest/ci/junit.xml | head -1)
              ERRORS=$(grep -oP 'errors="\K[0-9]+' target/nextest/ci/junit.xml | head -1)
              TIME=$(grep -oP 'time="\K[0-9.]+' target/nextest/ci/junit.xml | head -1)
              PASSED=$((TOTAL - FAILURES - ERRORS))
              echo "| Metric | Value |"
              echo "|--------|-------|"
              echo "| Total tests | ${TOTAL} |"
              echo "| Passed | ${PASSED} |"
              echo "| Failed | ${FAILURES} |"
              echo "| Errors | ${ERRORS} |"
              echo "| Duration | ${TIME}s |"
              echo ""
              if [ "${FAILURES}" = "0" ] && [ "${ERRORS}" = "0" ]; then
                echo "✅ All ${TOTAL} tests passed in ${TIME}s."
              else
                echo "❌ ${FAILURES} failures, ${ERRORS} errors out of ${TOTAL} tests."
              fi
            else
              echo "⚠️ JUnit XML not found. Check raw output above."
            fi
            echo ""
            echo "<details><summary>Doc-test output</summary>"
            echo ""
            echo '```'
            grep -E "^test |^running |^test result:" test-output.txt || echo "No doc-test output captured"
            echo '```'
            echo "</details>"
          } >> "$GITHUB_STEP_SUMMARY"

  # ── Cross-platform verification ──────────────────────────────────────
  cross-platform:
    name: Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2

      - name: Install cargo-nextest
        uses: taiki-e/install-action@cfdb446e391c69574ebc316dfb7d7849ec12b940 # v2
        with:
          tool: cargo-nextest

      - name: Run tests
        run: cargo nextest run --all-targets --profile ci

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: test-results-${{ matrix.os }}
          path: target/nextest/ci/junit.xml
          retention-days: 30
          if-no-files-found: warn

      - name: Summary
        if: always()
        run: |
          {
            echo "### Test Results (${{ matrix.os }})"
            echo ""
            if [ -f target/nextest/ci/junit.xml ]; then
              # Extract test count portably (works on both Linux and macOS)
              TOTAL=$(grep -o 'tests="[0-9]*"' target/nextest/ci/junit.xml | head -1 | tr -dc '0-9')
              FAILURES=$(grep -o 'failures="[0-9]*"' target/nextest/ci/junit.xml | head -1 | tr -dc '0-9')
              if [ -z "$TOTAL" ]; then
                echo "JUnit XML found but could not parse test counts."
              elif [ "${FAILURES:-0}" = "0" ]; then
                echo "✅ ${TOTAL} tests passed on ${{ matrix.os }}."
              else
                echo "❌ ${FAILURES} failures out of ${TOTAL} tests on ${{ matrix.os }}."
              fi
            else
              echo "JUnit XML not found at target/nextest/ci/junit.xml."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ── MSRV verification ────────────────────────────────────────────────
  msrv:
    name: MSRV (1.80)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@1.80
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          key: msrv-1.80
      - name: Check MSRV compilation
        id: msrv-check
        run: cargo check --all-targets
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.msrv-check.outcome }}" = "success" ]; then
            echo "### ✅ MSRV 1.80 compilation verified" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### ❌ MSRV 1.80 compilation failed" >> "$GITHUB_STEP_SUMMARY"
          fi

  # ── Benchmark compilation ────────────────────────────────────────────
  bench-compile:
    name: Benchmarks compile
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Compile benchmarks (no run)
        id: bench-check
        run: cargo bench --no-run
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.bench-check.outcome }}" = "success" ]; then
            echo "### ✅ All 7 benchmark suites compile" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### ❌ Benchmark compilation failed" >> "$GITHUB_STEP_SUMMARY"
          fi

  # ── Supply chain audit ───────────────────────────────────────────────
  deny:
    name: Cargo deny
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Run cargo deny
        id: deny-check
        uses: EmbarkStudios/cargo-deny-action@3fd3802e88374d3fe9159b834c7714ec57d6c979 # v2.0.15
        with:
          command: check advisories bans licenses sources
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.deny-check.outcome }}" = "success" ]; then
            {
              echo "### Supply Chain Audit"
              echo ""
              echo "| Check | Status |"
              echo "|-------|--------|"
              echo "| Advisories | ✅ |"
              echo "| Bans | ✅ |"
              echo "| Licenses | ✅ |"
              echo "| Sources | ✅ |"
            } >> "$GITHUB_STEP_SUMMARY"
          else
            echo "### ❌ Supply Chain Audit Failed" >> "$GITHUB_STEP_SUMMARY"
            echo "Review cargo-deny output above for details." >> "$GITHUB_STEP_SUMMARY"
          fi

  # ── SemVer compatibility ─────────────────────────────────────────────
  semver:
    name: Semver check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Install cargo-semver-checks
        run: cargo install cargo-semver-checks --locked
      - name: Check semver compatibility
        run: cargo semver-checks check-release --baseline-rev origin/main 2>&1 | tee semver-output.txt
      - name: Summary
        if: always()
        run: |
          {
            echo "### SemVer Compatibility"
            echo ""
            if grep -q "no semver update required\|all checks passed\|pass" semver-output.txt 2>/dev/null; then
              PASS=$(grep -oP '\d+ pass' semver-output.txt | head -1 || echo "unknown")
              echo "✅ ${PASS}ed — no breaking changes detected."
            else
              echo '```'
              tail -20 semver-output.txt
              echo '```'
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ── Code coverage ───────────────────────────────────────────────────
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 30
    continue-on-error: true
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin --locked
      - name: Generate coverage report
        run: cargo tarpaulin --out xml --out html --skip-clean 2>&1 | tee coverage-output.txt
      - name: Upload to Codecov
        if: always()
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: cobertura.xml
          fail_ci_if_error: false
      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: coverage-report
          path: |
            cobertura.xml
            tarpaulin-report.html
          retention-days: 30
          if-no-files-found: warn
      - name: Summary
        if: always()
        run: |
          {
            echo "### Code Coverage"
            echo ""
            if [ -f coverage-output.txt ]; then
              # Try Perl regex first (Linux), fall back to extended regex
              COVERAGE=$(grep -oP '\d+\.\d+% coverage' coverage-output.txt 2>/dev/null | tail -1 || \
                         grep -oE '[0-9]+\.[0-9]+% coverage' coverage-output.txt 2>/dev/null | tail -1 || \
                         echo "")
              if [ -n "$COVERAGE" ]; then
                echo "Line coverage: **${COVERAGE}**"
              else
                echo "Coverage report generated but percentage not parsed."
                echo ""
                echo "<details><summary>Raw output (last 10 lines)</summary>"
                echo ""
                echo '```'
                tail -10 coverage-output.txt
                echo '```'
                echo "</details>"
              fi
            else
              echo "Coverage output not captured. Check job logs for details."
            fi
            echo ""
            if [ -f cobertura.xml ]; then
              echo "Artifacts: cobertura.xml, tarpaulin-report.html"
            else
              echo "No coverage artifacts produced."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ── Extension build ─────────────────────────────────────────────────
  extension-build:
    name: Extension build
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          key: extension-build
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: "3.12"
      - name: Build extension
        run: |
          make configure
          make release
      - name: Verify extension artifact
        run: |
          test -f build/release/behavioral.duckdb_extension
          ls -lh build/release/behavioral.duckdb_extension
      - name: Summary
        if: always()
        run: |
          {
            echo "### Extension Build"
            echo ""
            if [ -f build/release/behavioral.duckdb_extension ]; then
              SIZE=$(wc -c < build/release/behavioral.duckdb_extension | xargs)
              SIZE="${SIZE} bytes"
              echo "✅ Extension built successfully."
              echo ""
              echo "| Artifact | Size |"
              echo "|----------|------|"
              echo "| \`behavioral.duckdb_extension\` | ${SIZE} |"
            else
              echo "❌ Extension artifact not found."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  # ── CI Gate (single required status check for branch protection) ────
  ci-gate:
    name: CI Gate
    if: always()
    needs:
      - fmt
      - clippy
      - check
      - doc
      - test
      - cross-platform
      - msrv
      - bench-compile
      - deny
      - semver
      - coverage
      - extension-build
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Evaluate job results
        run: |
          # These jobs must succeed (hard requirements)
          REQUIRED_RESULTS=(
            "fmt=${{ needs.fmt.result }}"
            "clippy=${{ needs.clippy.result }}"
            "check=${{ needs.check.result }}"
            "doc=${{ needs.doc.result }}"
            "test=${{ needs.test.result }}"
            "cross-platform=${{ needs.cross-platform.result }}"
            "msrv=${{ needs.msrv.result }}"
            "bench-compile=${{ needs.bench-compile.result }}"
            "deny=${{ needs.deny.result }}"
            "semver=${{ needs.semver.result }}"
            "extension-build=${{ needs.extension-build.result }}"
          )

          FAILED=0
          {
            echo "### CI Gate Summary"
            echo ""
            echo "| Job | Result |"
            echo "|-----|--------|"
          } >> "$GITHUB_STEP_SUMMARY"

          for entry in "${REQUIRED_RESULTS[@]}"; do
            JOB="${entry%%=*}"
            RESULT="${entry#*=}"
            case "$RESULT" in
              success)  ICON="✅" ;;
              skipped)  ICON="⏭️" ;;
              *)        ICON="❌"; FAILED=$((FAILED + 1)) ;;
            esac
            echo "| ${JOB} | ${ICON} ${RESULT} |" >> "$GITHUB_STEP_SUMMARY"
          done

          # Coverage is informational (continue-on-error)
          echo "| coverage | ℹ️ ${{ needs.coverage.result || 'skipped' }} (informational) |" >> "$GITHUB_STEP_SUMMARY"

          echo "" >> "$GITHUB_STEP_SUMMARY"

          if [ "$FAILED" -gt 0 ]; then
            echo "❌ **${FAILED} required job(s) failed.** See individual job logs above." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "✅ **All required CI checks passed.**" >> "$GITHUB_STEP_SUMMARY"
          fi

  # Coverage is not in the gate — it's informational only
  # It runs independently and reports to Codecov
